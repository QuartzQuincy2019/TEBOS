<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
    <title>Text Encrypter Based On Sanskrit - TEBOS</title>
    <script>
        //database.js
        const consonants = [
            "ट", "ठ", "ड", "ख", "थ", "घ", "ङ", "च", "छ", "फ",//0-9
            "झ", "ञ", "ढ", "त", "र", "ल", "व", "ज", "ग", "द",//10-19
            "ध", "न", "प", "क", "ब", "भ", "म", "य", "स", "ण",//20-29
            "श", "ष"   // 32个辅音字母 (0-31)
        ];
        const diacritics = [
            "ी", "ू", "ि", "ु", "े", "ा", "ौ", "ो"// 8附标 (0-7)
        ];
        const separators = ["ृ", "्", "ै"];
        const conMap = new Map(consonants.map((char, idx) => [char, idx]));
        const diaMap = new Map(diacritics.map((char, idx) => [char, idx]));

        const rev_con = new Map();
        conMap.forEach((value, key) => {
            rev_con.set(key, value);
        });
        const rev_dia = new Map();
        diaMap.forEach((value, key) => {
            rev_dia.set(key, value);
        });
    </script>
    <script>
        /**
         * 字符串分组
         * @param {string} str "andyouare"
         * @param {number} n 3
         * @returns ["and","you","are"]
         */
        function splitIntoChunks(str, n) {
            const result = [];
            for (let i = 0; i < str.length; i += n) {
                result.push(str.substring(i, i + n));
            }
            return result;
        }
        Array.prototype.mixUp = function (indexes, element) {
            const validIndexes = [...new Set(indexes)]
                .filter(idx =>
                    Number.isInteger(idx) &&
                    idx >= 0 &&
                    idx < this.length
                );
            validIndexes.sort((a, b) => b - a);
            validIndexes.forEach(idx => {
                this.splice(idx + 1, 0, element);
            });
            return this;
        };
        Array.prototype.deleteAll = function (element) {
            for (let i = this.length - 1; i >= 0; i--) {
                if (this[i] === element) {
                    this.splice(i, 1);
                }
            }
            return this;
        };
        function paveWay(arr, target) {
            // 记录所有需要删除的索引位置
            const indicesToDelete = new Set();
            for (let i = 0; i < arr.length; i++) {
                if (arr[i] === target && i > 0) {
                    if (arr[i - 1] !== target) {
                        indicesToDelete.add(i - 1);
                    }
                }
            }
            const sortedIndices = Array.from(indicesToDelete).sort((a, b) => b - a);
            for (const index of sortedIndices) {
                arr.splice(index, 1);
            }
            return arr;
        }
        /**
         * 
         * @param {array} bytes 给出UTF-8的编码：[228, 184, 173]，返回对应Unicode字符。
         * @returns 
         */
        function getCharFromUTF8Bytes(bytes) {
            const decoder = new TextDecoder('utf-8');
            return decoder.decode(new Uint8Array(bytes));
        }

        /**
         * 
         * @param {string} char 获取单个字符的UTF-8编码
         * @returns 
         */
        function getUTF8Bytes(char) {
            const encoder = new TextEncoder();
            return Array.from(encoder.encode(char));
        }
        //Deva-B32p8加密系统
        function Deva_B32p8(text) {
            const encoder = new TextEncoder();
            let binaryStr = encoder.encode(text);
            var bytes = [...binaryStr];
            bytes = bytes.map(byte => byte.toString(2).padStart(8, '0'));
            var ciphers = [];
            for (var i = 0; i < bytes.length; i++) {
                let integer = parseInt(bytes[i], 2);
                const char2 = diacritics[integer % 8];
                const char1 = consonants[(integer - integer % 8) / 8];
                const char = char1 + char2;
                ciphers.push(char1 + char2);
            }
            var lastSpace = 0;
            var indexes = [];
            for (var i = 0; i < ciphers.length; i++) {
                if (i - lastSpace >= 2 && ciphers.length - i >= 2) {
                    if (Math.random() >= 0.4) {
                        indexes.push(i);
                        lastSpace = i;
                    }
                }
            }
            ciphers.mixUp(indexes, " ");
            return ciphers.join("");
        }
        function de_B32p8(ciphers) {
            ciphers = ciphers.split("");
            ciphers.deleteAll(" ");
            console.log(ciphers);
            var u = new Array();
            for (var i = 0; i < ciphers.length;) {
                let C1 = rev_con.get(ciphers[i]);
                let A1 = rev_dia.get(ciphers[i + 1]);
                res = C1 * 8 + A1;
                i += 2;
                u.push(res);
            }
            console.log(u);
            let decoder = new TextDecoder();
            var bytes = new Uint8Array(u);
            return decoder.decode(bytes);
        }
        //Deva_D32p8M加密系统
        function Deva_D32p8M(text) {
            var ciphers = [];
            for (const char of text) {
                var cipher = "";
                var char_result = [];
                const bytes = getUTF8Bytes(char);
                for (const byte of bytes) {
                    const char2 = diacritics[byte % 8];
                    const char1 = consonants[(byte - byte % 8) / 8];
                    const char = char1 + char2;
                    // console.log(char);
                    char_result.push(char1 + char2);
                }
                char_result.push(consonants[Math.floor(Math.random() * consonants.length)] + separators[Math.floor(Math.random() * separators.length)]);
                cipher = char_result.join("");
                ciphers.push(cipher);
            }
            ciphers = ciphers.join("").split("");
            var lastSpace = 0;
            var indexes = [];
            for (var i = 0; i < ciphers.length; i++) {
                if (i - lastSpace >= 2 && i % 2 == 1 && ciphers.length - i >= 2) {
                    if (Math.random() >= 0.4) {
                        indexes.push(i);
                        lastSpace = i;
                    }
                }
            }
            ciphers.mixUp(indexes, " ");
            return ciphers.join("");
        }
        function de_D32p8M(ciphers) {
            var ciphers_set = ciphers.split("");
            ciphers_set.deleteAll(" ");
            ciphers_set = paveWay(ciphers_set, separators[0]);
            ciphers_set = paveWay(ciphers_set, separators[1]);
            ciphers_set = paveWay(ciphers_set, separators[2]);
            ciphers_set = ciphers_set.join("").split(separators[0])
                .join("").split(separators[1])
                .join("").split(separators[2]);
            var plaintext = [];
            for (cipher of ciphers_set) {
                var bytes = [];
                var res = 0;
                const units = splitIntoChunks(cipher, 2);
                for (unit of units) {
                    let C1 = rev_con.get(unit[0]);
                    let A1 = rev_dia.get(unit[1]);
                    res = C1 * 8 + A1;
                    bytes.push(res);
                }
                plaintext.push(getCharFromUTF8Bytes(bytes));
            }
            return plaintext.join("");
        }

        var MODE = 'Deva-B32p8';
        function encrypt(text, mode = 'Deva-B32p8') {
            var ciphers = [];
            if (mode == 'Deva-B32p8') ciphers = Deva_B32p8(text);
            if (mode == 'Deva-D32p8M') ciphers = Deva_D32p8M(text);
            return ciphers
        }

        function decrypt(ciphers, mode = 'Deva-B32p8') {
            if (mode == 'Deva-B32p8') return de_B32p8(ciphers);
            if (mode == 'Deva-D32p8M') return de_D32p8M(ciphers);
        }
    </script>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        * {
            font-family: 'Times New Roman', Times, serif;
            transition: background-color 0.3s, color 0.3s;
        }

        textarea {
            display: block;
            width: 100%;
            box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 0.4em;
        }

        .input {
            min-height: 8em;
            font-size: 2.5em;
        }

        .results {
            box-sizing: border-box;
            border: 4px solid var(--text-color);
            padding: 0.2em;
            border-radius: 10px;
            font-size: 2.5em;
            overflow-wrap: break-word;
        }

        .sanskrit {
            font-family: 'Sanskrit Text', 'Times New Roman';
        }

        .plain.results {
            min-height: 10em;
        }

        .sanskrit.results {
            min-height: 10em;
        }

        button {
            color: #000;
            font-size: 2em;
            padding: 0.4em;
            margin: 0.2em;
        }

        form {
            color: #63e115;
            text-shadow: 1px 1px 0px #000;
            font-size: 2em;
        }

        a {
            text-decoration: none;
            font-weight: 1000;
            color: #ff6ac1;
        }

        a:visited {
            color: #ff6ac1;
        }
    </style>
</head>

<body>
    <h1>Text Encrypter Based On Sanskrit - TEBOS</h1>
    <h3>Author: QuartzStudio2019(Quincy) - All Rights Reserved</h3>
    <p>装载Sanskrit Text字体，体验更佳。</p>
    <h3>v3.0.0</h3>
    <button title="切换色调" onclick="changeSkin();">切换色调</button>
    <p>经TEBOS加密后的密文是无意义但可读的。可前往<a title="Sanskrit Transliteration Tool" target="_blank"
            href="https://www.yesvedanta.com/transliterate/">梵语转写工具网站</a>，参考"IAST"栏来查询密文的读音。</p>
    <h2>加密算法选择</h2>
    <form id="AlgorithmSelection">
        <input type="radio" id="Algo_B32p8" name="加密算法" value="Deva-B32p8" checked />
        <label for="Algo_B32p8">Deva-B32p8</label>
        <br>
        <input type="radio" id="Algo_D32p8M" name="加密算法" value="Deva-D32p8M" />
        <label for="Algo_D32p8M">Deva-D32p8M</label>
    </form>
    <p>Deva-B32p8：密文相对更短，计算更快，无掩码。Deva-D32p8M：密文相对更长，有掩码。两算法基本逻辑相同。</p>
    <hr>
    <h1>解密 - Decrypt</h1>
    <textarea title="解密" id="decoding" class="sanskrit input"></textarea>
    <button title="复制" onclick="copyPlaintext();">复制明文</button>
    <textarea title="明文" id="plaintext" class="results plain" readonly>---Plaintext---</textarea>
    <hr>
    <h1>加密 - Encrypt</h1>
    <textarea title="加密" id="encoding" class="plain input"></textarea>
    <button title="复制" onclick="copyCipher();">复制密文</button>
    <textarea title="密文" id="cipher" class="results sanskrit" readonly>---Cipher---</textarea>
    <script>
        function de() {
            document.getElementById("plaintext").value = decrypt(document.getElementById("decoding").value, MODE);
        }
        function en() {
            document.getElementById("cipher").value = encrypt(document.getElementById("encoding").value, MODE);
        }
        document.getElementById("decoding").addEventListener("input", () => {
            de();
        });
        document.getElementById("encoding").addEventListener("input", () => {
            en();
        });
        function copyPlaintext() {
            navigator.clipboard.writeText(document.getElementById("plaintext").value);
        }
        function copyCipher() {
            navigator.clipboard.writeText(document.getElementById("cipher").value);
        }
    </script>
    <script>
        var skin = 'dark';
        function changeSkin() {
            if (skin == 'dark') {
                document.documentElement.style.setProperty("--bg-color", "#ffffff");
                document.documentElement.style.setProperty("--text-color", "#000000");
                skin = 'light';
            } else {
                document.documentElement.style.setProperty("--bg-color", "#000000");
                document.documentElement.style.setProperty("--text-color", "#ffffff");
                skin = 'dark';
            }
        }
        document.getElementById("AlgorithmSelection").addEventListener('change', () => {
            if (document.getElementById("Algo_B32p8").checked === true) MODE = 'Deva-B32p8';
            if (document.getElementById("Algo_D32p8M").checked === true) MODE = 'Deva-D32p8M';
            de();en();
        })
    </script>
</body>

</html>